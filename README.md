# Basic Static-Dynamic Malware Analysis

Malware analysis is the process of understanding the behaviour and purpose of a suspicious file or URL. The output of the analysis aids in the detection and mitigation of the potential threat.

## Malware Sample

> **MD5:**  1d8562c0adcaee734d63f7baaca02f7c

> **SHA256:**  92730427321a1c4ccfc0d0580834daef98121efa9bb8963da332bfd6cf1fda8a


## Basic Static Analysis :

### Hashing Malware Sample

- Getting File Hash is important part of Static Analysis. We will use this hash to check reputation of binary  on multiple automated sandbox like VirusTotal.

![image](https://user-images.githubusercontent.com/43460691/213197987-9981444b-cc9b-4cc8-b61b-70ea849f9c12.png)


### Malware Repositories

- The very first technique in static analysis is to upload the suspicious executable or hash on VirusTotal, which runs the executable against several AV solutions and gives the result. For example, the below file states that the detection ratio is 46 out of 70.

- You can check the below output, Multiple AV solutions  detected  our sample as a Trojan.

![image](https://user-images.githubusercontent.com/43460691/213198777-4b7a0c68-a0fe-4053-9940-2bdb60018778.png)


### String Analysis

- Searching through the strings can be a simple way to get hints about the functionality of a program. For example, if the program accesses a URL, then you will see the URL accessed stored as a string in the program.

- Below is a string extraction of keywords from a malicious executable. As we can see, it gives us good information that URL, File Path and Commands.

- From the below strings output we can assume that malware connecting to external URL to download file.

``` 
C:\Users\Windows\Desktop
λ floss Malware.exe
FLOSS static Unicode strings
jjjj
cmd.exe /C ping 1.1.1.1 -n 1 -w 3000 > Nul & Del /f /q "%s"
http://ssl-6582datamanager.helpdeskbros.local/favicon.ico
C:\Users\Public\Documents\CR433101.dat.exe
Mozilla/5.0
http://huskyhacks.dev
ping 1.1.1.1 -n 1 -w 3000 > Nul & C:\Users\Public\Documents\CR433101.dat.exe
open

FLOSS decoded 0 strings

FLOSS extracted 2 stackstrings
<2_/
ineIGenu

Finished execution after 0.875000 seconds
```

### Information gathering using PEView Tool.

- PE file format is used by Windows executables, DDLs etc. It contains the necessary information for Windows OS loader to run the code. While examining the PE files, we can analyse which functions have been imported, exported and what type of linking is there i.e. runtime, static or dynamic.

- Below are the some inportant sections from the our malware file.

**DOS Header**

- Every PE file starts with a 64-bytes-long structure called the DOS header, it’s what makes the PE file an MS-DOS executable.

![image](https://user-images.githubusercontent.com/43460691/213241539-750e222a-2a8e-42ce-968e-3642b72ecf2d.png)

**File Header**

- File Header holds the information about the PE file like creation time, file size etc.

![image](https://user-images.githubusercontent.com/43460691/213241726-fc75bf1a-ea64-491a-b09b-23448f25903e.png)

**Section Header**

- Sections are where the actual contents of the file are stored, these include things like data and resources that the program uses, and also the actual code of the program, there are several sections each one with its own purpose.

- **.text:** This contains the executable code.

- **.rdata:** This sections holds read only globally accessible data.

- **.data:** Stores global data accessed through the program.

- **.rsrc:** This sections stores resources needed by the executable.

![image](https://user-images.githubusercontent.com/43460691/213242988-1eef017e-4aec-4067-baec-632085cc70fa.png)

**Import Address Table**

- The import address table is the part of the Windows module (executable or dynamic link library) which records the addresses of functions imported from other DLLs.

![image](https://user-images.githubusercontent.com/43460691/213243406-adea35db-20a5-4379-a3f3-66ade9e25930.png)
![image](https://user-images.githubusercontent.com/43460691/213243480-dfe7421d-c1a5-4ba8-b7aa-3fee41d954d4.png)

### Information gathering using PEStudio Tool.

- PeStudio is used to check for suspicious artifacts within executable files in order to speed up the initial malware assessment. It extracts the imports, exports, strings, resources, indicators, groups, and thresholds from the malware file. 

- This tool also provides MITRE attack indicators associated with imports and retrieves Virustotal detection ratio.

- Check the below PeStudio result of our malware file.

![image](https://user-images.githubusercontent.com/43460691/213245902-8e8093d8-e969-409e-8cbe-14e7345afd07.png)


![image](https://user-images.githubusercontent.com/43460691/213245929-52ade2c2-4dbc-4274-937a-514cc467e38d.png)

### Identifying Malware Capabilities using CAPA Tool.

- Capa is a program that detects malicious capabilities in suspicious programs by using a set of rules. These rules are meant to be as high-level and human readable as possible. For example, Capa will examine a binary, identify an API call or string of interest, and match this piece of information against a rule that is called "receive data" or "connect to a URL". It translates the technical information in a binary into a simple, human-readable piece of information.

> ***`capa file path file name`***

- Capa has examined the binary, pulled out interesting information from the binary, matched it against its default rule set, and matched some suspected capabilities to items from the MITRE ATT&CK Framework. This time, we don't have much to go on. We get a match for the ATT&CK item "T1129 - Shared Modules". 

![image](https://user-images.githubusercontent.com/43460691/213246813-535e4f18-ce5a-427f-a25d-bbd5dd3397bc.png)

- Let's run Capa one more time with a double verbose output.

> ***`capa file path file name -vv`***

- The output for the "download URL to file" rule indicates that this rule triggers when the urlmon.URLDownloadToFile API call is located in the binary. It has identified this API call, provides the location in the binary where it is called, and provides some examples of where this kind of malware behavior has been seen before.

![image](https://user-images.githubusercontent.com/43460691/213247819-efde1d22-7014-44f7-9c0a-04345292ce0c.png)


## Basic Dynamic Analysis 

![image](https://user-images.githubusercontent.com/43460691/213248318-48464e17-2b73-42d1-990a-e294beaf433f.png)


![image](https://user-images.githubusercontent.com/43460691/213248364-4353b03e-d635-420b-986d-ec3fb49a9c82.png)


![image](https://user-images.githubusercontent.com/43460691/213248416-5bbc4932-16ea-4a3c-bcd5-0a3221ee19bf.png)


![image](https://user-images.githubusercontent.com/43460691/213248471-9ac46a87-faa7-49a7-af38-22ea23cb2cc6.png)


## Malware Execuation Flow.

![image](https://user-images.githubusercontent.com/43460691/213248737-94a42e2a-b8c8-4de8-92a0-e4da8c426765.png)


## Referances 


















